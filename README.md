# terraform_l

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Terraform –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã (VM) –≤ –Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–µ (Yandex Cloud).

## –°–æ—Å—Ç–∞–≤
- –°–æ–∑–¥–∞—ë—Ç –æ–¥–Ω—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É —Å –ø–æ–º–æ—â—å—é —Ä–µ—Å—É—Ä—Å–∞ `yandex_compute_instance`.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏ –æ–±–ª–∞–∫–∞, –ø–∞–ø–∫–∏, –∑–æ–Ω—ã, —Ç–æ–∫–µ–Ω–∞ –∏ –ø–æ–¥—Å–µ—Ç–∏.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- [Terraform](https://www.terraform.io/) >= 0.13
- –ê–∫–∫–∞—É–Ω—Ç –≤ [Yandex Cloud](https://cloud.yandex.ru/)
- –°–æ–∑–¥–∞–Ω–Ω—ã–µ Cloud ID, Folder ID, Subnet ID
- OAuth-—Ç–æ–∫–µ–Ω Yandex Cloud

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ò–º—è           | –û–ø–∏—Å–∞–Ω–∏–µ                        | –¢–∏–ø    | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|---------------|----------------------------------|--------|--------------|----------------------|
| yc_token      | Yandex Cloud OAuth token         | string | –¥–∞           | -                    |
| yc_cloud_id   | Yandex Cloud ID                  | string | –¥–∞           | -                    |
| yc_folder_id  | Yandex Cloud Folder ID           | string | –¥–∞           | -                    |
| yc_zone       | Yandex Cloud default zone        | string | –Ω–µ—Ç          | ru-central1-a        |
| subnet_id     | Subnet ID –¥–ª—è VM                 | string | –¥–∞           | -                    |

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞:
   ```sh
   git clone <repo_url>
   cd terraform_l
   ```
2. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `terraform.tfvars` –∏ —É–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:
   ```sh
   cp terraform.tfvars.example terraform.tfvars
   # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ terraform.tfvars –∏ —É–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
   ```
   ```hcl
   yc_token    = "<–≤–∞—à_yc_token>"
   yc_cloud_id = "<–≤–∞—à_cloud_id>"
   yc_folder_id = "<–≤–∞—à_folder_id>"
   subnet_id   = "<–≤–∞—à_subnet_id>"
   # yc_zone –º–æ–∂–Ω–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å, –µ—Å–ª–∏ –ø–æ–¥—Ö–æ–¥–∏—Ç ru-central1-a
   ```
3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Terraform:
   ```sh
   terraform init
   ```
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–ª–∞–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:
   ```sh
   terraform plan
   ```
5. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
   ```sh
   terraform apply
   ```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–í–ê–ñ–ù–û:** –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —Ñ–∞–π–ª—ã —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –≤ Git!

- –§–∞–π–ª `terraform.tfvars` —Å–æ–¥–µ—Ä–∂–∏—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ **–ù–ï –î–û–õ–ñ–ï–ù** –ø–æ–ø–∞–¥–∞—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `terraform.tfvars.example` –∫–∞–∫ —à–∞–±–ª–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
- –§–∞–π–ª `.gitignore` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:
  - `*.tfvars` - —Ñ–∞–π–ª—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
  - `*.tfstate*` - —Ñ–∞–π–ª—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è Terraform
  - `.terraform/` - –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã Terraform
  - `backend.hcl` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è backend

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ CI/CD
2. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ–∫—Ä–µ—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (HashiCorp Vault, AWS Secrets Manager)
3. –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤
- `main.tf` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π VM –∏ backend
- `variables.tf` ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- `outputs.tf` ‚Äî –≤—ã—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (IP –∞–¥—Ä–µ—Å–∞, –∏–º–µ–Ω–∞ —Ä–µ—Å—É—Ä—Å–æ–≤)
- `terraform.tfvars.example` ‚Äî –ø—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤)
- `.gitignore` ‚Äî –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è Git (–∑–∞—â–∏—â–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç—ã)
- `README.md` ‚Äî —ç—Ç–æ—Ç —Ñ–∞–π–ª

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
- –ó–Ω–∞—á–µ–Ω–∏–µ `core_fraction` –≤ —Ä–µ—Å—É—Ä—Å–µ VM –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ 5 ‚Äî —ç—Ç–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–æ–ª—è CPU, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ª–∏ –æ–Ω–∞ –≤ –≤–∞—à–µ–º —Ä–µ–≥–∏–æ–Ω–µ/–∫–≤–æ—Ç–µ.
- –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ VM –ø–æ –ø—É–±–ª–∏—á–Ω–æ–º—É IP –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è NAT.
- –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
  ```sh
  terraform destroy
  ```

---

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Terraform State

Terraform –∏—Å–ø–æ–ª—å–∑—É–µ—Ç state-—Ñ–∞–π–ª (`terraform.tfstate`) –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –≠—Ç–æ—Ç —Ñ–∞–π–ª –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫:
- –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∂–µ–ª–∞–µ–º–æ–≥–æ –∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ `plan` –∏ `apply`.

### –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å state-—Ñ–∞–π–ª–æ–º?

- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –í state-—Ñ–∞–π–ª–µ –º–æ–≥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–∞—Ä–æ–ª–∏, —Ç–æ–∫–µ–Ω—ã, IP-–∞–¥—Ä–µ—Å–∞) –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ.
- **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å:** –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, –ª–æ–∫–∞–ª—å–Ω—ã–π state-—Ñ–∞–π–ª –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º –∏ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö.
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ü–æ—Ç–µ—Ä—è state-—Ñ–∞–π–ª–∞ = –ø–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ö—Ä–∞–Ω–µ–Ω–∏—é state

- **–õ–æ–∫–∞–ª—å–Ω—ã–π state** –ø–æ–¥—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –∏ –æ–±—É—á–µ–Ω–∏—è. –î–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ remote backend.
- **Remote backend** ‚Äî —ç—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ state-—Ñ–∞–π–ª–∞ –≤ –æ–±–ª–∞–∫–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
  - AWS: S3 + DynamoDB (–¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)
  - Azure: Azure Storage Account
  - GCP: Google Cloud Storage
  - Terraform Cloud/Enterprise

#### –ü—Ä–∏–º–µ—Ä backend –¥–ª—è AWS S3 + DynamoDB

```hcl
terraform {
  backend "s3" {
    bucket         = "my-terraform-state"
    key            = "global/s3/terraform.tfstate"
    region         = "eu-central-1"
    dynamodb_table = "my-terraform-locks"
    encrypt        = true
  }
}
```

- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (Locking):** –ù–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è state –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏. –í AWS –¥–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DynamoDB.

### –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

- State-—Ñ–∞–π–ª –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ.
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞—Ç—Ä–∏–±—É—Ç `sensitive = true` –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ output, —á—Ç–æ–±—ã —Å–∫—Ä—ã–≤–∞—Ç—å –∏—Ö –≤ –≤—ã–≤–æ–¥–µ Terraform.
- –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, AWS Secrets Manager, HashiCorp Vault).